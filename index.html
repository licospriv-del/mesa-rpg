<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesa de RPG</title>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  padding:16px;
  margin:0
}
button,input{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px
}
.box{
  border:1px solid #444;
  padding:12px;
  margin-top:12px;
  border-radius:8px
}
</style>
</head>

<body>

<h1>Mesa de RPG ğŸ²</h1>

<!-- SENHA GLOBAL -->
<div id="telaSenha">
  <input id="senhaGlobal" type="password" placeholder="Senha da mesa">
  <button id="btnSenha">Entrar</button>
</div>

<!-- AUTH -->
<div id="telaAuth" style="display:none">
  <input id="email" type="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button id="btnLogin">Entrar / Cadastrar</button>
</div>

<!-- ESCOLHA -->
<div id="telaLogin" style="display:none">
  <button id="btnJogador">Jogador</button>
  <button id="btnMestre">Mestre</button>
</div>

<!-- PERSONAGENS -->
<div id="telaPersonagens" style="display:none">
  <button id="btnVoltar">â¬… Voltar</button>
  <div id="listaPersonagens"></div>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">
  <button id="btnSairMesa">ğŸšª Sair da mesa</button>
  <h2 id="bemVindo"></h2>

  <div id="controleMestre" class="box" style="display:none">
    <p>Ãrea do Mestre</p>
  </div>

  <div id="areaJogador" class="box" style="display:none">
    <button id="btnRolar">ğŸ² Rolar dado</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  set,
  onValue,
  remove,
  push,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCzAXZ0RWY-RtgKVDUeqrnmImaN9hAxMmI",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ELEMENTOS */
const telaSenha = document.getElementById("telaSenha");
const telaAuth = document.getElementById("telaAuth");
const telaLogin = document.getElementById("telaLogin");
const telaPersonagens = document.getElementById("telaPersonagens");
const painel = document.getElementById("painel");

const btnSenha = document.getElementById("btnSenha");
const btnLogin = document.getElementById("btnLogin");
const btnJogador = document.getElementById("btnJogador");
const btnMestre = document.getElementById("btnMestre");
const btnVoltar = document.getElementById("btnVoltar");
const btnSairMesa = document.getElementById("btnSairMesa");

const listaPersonagens = document.getElementById("listaPersonagens");
const bemVindo = document.getElementById("bemVindo");

const senhaGlobal = document.getElementById("senhaGlobal");
const email = document.getElementById("email");
const senha = document.getElementById("senha");

/* ESTADO */
let UID = null;
let nickAtual = null;
let passouSenhaGlobal = false;

/* RESET */
function esconderTudo(){
  telaSenha.style.display="none";
  telaAuth.style.display="none";
  telaLogin.style.display="none";
  telaPersonagens.style.display="none";
  painel.style.display="none";
  document.getElementById("controleMestre").style.display="none";
  document.getElementById("areaJogador").style.display="none";
}

/* ğŸ”¥ DESLOGA FIREBASE SEMPRE AO CARREGAR */
await signOut(auth);

/* INÃCIO */
esconderTudo();
telaSenha.style.display="block";

/* SENHA GLOBAL */
btnSenha.onclick = () => {
  if (senhaGlobal.value !== "somosumbra") {
    alert("Senha incorreta");
    return;
  }
  passouSenhaGlobal = true;
  esconderTudo();
  telaAuth.style.display="block";
};

/* LOGIN */
btnLogin.onclick = async () => {
  try{
    await signInWithEmailAndPassword(auth, email.value, senha.value);
  }catch{
    await createUserWithEmailAndPassword(auth, email.value, senha.value);
  }
};

/* AUTH STATE */
onAuthStateChanged(auth, user => {
  if (!passouSenhaGlobal) return;

  esconderTudo();

  if(user){
    UID = user.uid;
    telaLogin.style.display="block";
  }else{
    telaAuth.style.display="block";
  }
});

/* ESCOLHA */
btnJogador.onclick = () => {
  esconderTudo();
  telaPersonagens.style.display="block";
  listaPersonagens.innerHTML="";

  onValue(ref(db,`usuarios/${UID}/personagens`), snap=>{
    snap.forEach(p=>{
      const b=document.createElement("button");
      b.textContent=p.key;
      b.onclick=()=>entrarPersonagem(p.key);
      listaPersonagens.appendChild(b);
    });

    const novo=document.createElement("button");
    novo.textContent="â• Novo personagem";
    novo.onclick=()=>entrarPersonagem(prompt("Nome do personagem"),true);
    listaPersonagens.appendChild(novo);
  },{onlyOnce:true});
};

btnVoltar.onclick = () => {
  esconderTudo();
  telaLogin.style.display="block";
};

/* MESTRE */
btnMestre.onclick = () => {
  if(prompt("Senha do mestre")!=="souomestredosmagos") return;
  iniciar("mestre");
};

/* PERSONAGEM */
function entrarPersonagem(nick,novo=false){
  if(!nick) return;
  nickAtual=nick;
  const r=ref(db,`jogadores/${UID}_${nick}`);
  set(r,{nick,online:true});
  if(novo) set(ref(db,`usuarios/${UID}/personagens/${nick}`),true);
  onDisconnect(r).remove();
  iniciar("jogador");
}

/* INICIAR */
function iniciar(tipo){
  esconderTudo();
  painel.style.display="block";
  bemVindo.textContent = nickAtual || "Mestre";

  if(tipo==="mestre"){
    document.getElementById("controleMestre").style.display="block";
  }else{
    document.getElementById("areaJogador").style.display="block";
  }
}

/* SAIR DA MESA */
btnSairMesa.onclick = async () => {
  if(nickAtual){
    remove(ref(db,`jogadores/${UID}_${nickAtual}`));
    nickAtual=null;
  }
  await signOut(auth);
  passouSenhaGlobal=false;
  esconderTudo();
  telaSenha.style.display="block";
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesa de RPG</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:16px;
  margin:0;
}
h1,h2,h3,h4{margin:8px 0}
button,input{
  padding:12px;
  margin:6px 0;
  width:100%;
  font-size:16px;
}
.box{
  border:1px solid #444;
  padding:12px;
  margin-top:12px;
  border-radius:8px;
}
@media (min-width:768px){
  body{max-width:700px;margin:auto}
}
</style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<div id="telaSenha">
  <input id="senhaGlobal" type="password" placeholder="Senha da mesa">
  <button id="btnSenha">Entrar</button>
</div>

<div id="telaAuth" style="display:none">
  <input id="email" type="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button id="btnLogin">Entrar / Cadastrar</button>
</div>

  <div id="telaLogin" style="display:none">
  <button id="btnVoltar" style="display:none">â¬… Voltar</button>
  <button id="btnJogador">Jogador</button>
  <button id="btnMestre">Mestre</button>
</div>

<div id="painel" style="display:none">
  <h2 id="bemVindo"></h2>

  <div id="controleMestre" class="box" style="display:none">
    <input id="dtAtual" type="number" placeholder="DT">
    <button id="btnDT">Definir DT</button>
    <button id="btnLimpar">ðŸ§¹ Limpar histÃ³rico</button>
    <div id="listaJogadores"></div>
  </div>

  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button id="btnRolar">ðŸŽ² Rolar dado</button>
  </div>

  <ul id="historico"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  set,
  onValue,
  push,
  remove,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ===== FIREBASE CONFIG (REAL, FUNCIONANDO) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCzAXZ0RWY-RtgKVDUeqrnmImaN9hAxMmI",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195",
  storageBucket: "mesa-rpg-9f195.firebasestorage.app",
  messagingSenderId: "413626106286",
  appId: "1:413626106286:web:10d5b7dd73c8d083c4883f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ===== ELEMENTOS ===== */
  const btnVoltar = document.getElementById("btnVoltar");
const telaSenha = document.getElementById("telaSenha");
const telaAuth = document.getElementById("telaAuth");
const telaLogin = document.getElementById("telaLogin");
const painel = document.getElementById("painel");

const senhaGlobal = document.getElementById("senhaGlobal");
const btnSenha = document.getElementById("btnSenha");

const email = document.getElementById("email");
const senha = document.getElementById("senha");
const btnLogin = document.getElementById("btnLogin");

const btnJogador = document.getElementById("btnJogador");
const btnMestre = document.getElementById("btnMestre");

const bemVindo = document.getElementById("bemVindo");

const controleMestre = document.getElementById("controleMestre");
const areaJogador = document.getElementById("areaJogador");

const btnRolar = document.getElementById("btnRolar");
const btnDT = document.getElementById("btnDT");
const btnLimpar = document.getElementById("btnLimpar");

const dtAtual = document.getElementById("dtAtual");
const listaJogadores = document.getElementById("listaJogadores");
const historico = document.getElementById("historico");
const infoJogador = document.getElementById("infoJogador");

/* ===== VARIÃVEIS ===== */
let UID = null;
let nickAtual = null;
let DT = 0;

/* ===== SENHA GLOBAL ===== */
btnSenha.addEventListener("click", () => {
  if (senhaGlobal.value !== "somosumbra") {
    alert("Senha incorreta");
    return;
  }
  telaSenha.style.display = "none";
  telaAuth.style.display = "block";
});

/* ===== AUTH ===== */
btnLogin.addEventListener("click", async () => {
  try {
    await signInWithEmailAndPassword(auth, email.value, senha.value);
  } catch (e) {
    await createUserWithEmailAndPassword(auth, email.value, senha.value);
  }
});

onAuthStateChanged(auth, user => {
  if (!user) return;
  UID = user.uid;
  telaAuth.style.display = "none";
  telaLogin.style.display = "block";
});

/* ===== ESCOLHA ===== */
btnJogador.addEventListener("click", () => {
  const base = ref(db, `usuarios/${UID}/personagens`);
  onValue(base, snap => {
    telaLogin.innerHTML = "<h3>Escolha personagem</h3>";
    snap.forEach(p => {
      const b = document.createElement("button");
      b.textContent = p.key;
      b.onclick = () => entrarPersonagem(p.key);
      telaLogin.appendChild(b);
    });
    const novo = document.createElement("button");
    novo.textContent = "âž• Novo personagem";
    novo.onclick = novoPersonagem;
    telaLogin.appendChild(novo);
  }, { onlyOnce:true });
});
  btnVoltar.addEventListener("click", () => {
  voltarParaEscolha();
});


btnMestre.addEventListener("click", () => {
  const s = prompt("Senha do mestre");
  if (s !== "souomestredosmagos") return alert("Senha errada");
  iniciar("mestre");
});

/* ===== JOGADOR ===== */
function novoPersonagem(){
  const n = prompt("Nome do personagem");
  if (!n) return;
  entrarPersonagem(n,true);
}

function entrarPersonagem(nick, novo=false){
  nickAtual = nick;
  const r = ref(db, `jogadores/${UID}_${nick}`);
  set(r,{uid:UID,nick,rolls:1,dado:20,online:true});
  if(novo) set(ref(db,`usuarios/${UID}/personagens/${nick}`),{criado:Date.now()});
  onDisconnect(r).remove();
  iniciar("jogador");
}

/* ===== INICIAR ===== */
function iniciar(tipo){
  telaLogin.style.display="none";
  painel.style.display="block";
  bemVindo.innerText = nickAtual || "Mestre";

  ouvirDT();
  ouvirHistorico();

  if(tipo==="mestre"){
    controleMestre.style.display="block";
    ouvirJogadores();
  }else{
    areaJogador.style.display="block";
    ouvirStatusJogador();
  }
}

/* ===== FIREBASE ===== */
function ouvirJogadores(){
  onValue(ref(db,"jogadores"), snap=>{
    listaJogadores.innerHTML="";
    snap.forEach(j=>{
      if(j.val().online){
        const d=document.createElement("div");
        d.textContent=j.val().nick;
        listaJogadores.appendChild(d);
      }
    });
  });
}

function ouvirHistorico(){
  onValue(ref(db,"historico"), snap=>{
    historico.innerHTML="";
    snap.forEach(s=>{
      const li=document.createElement("li");
      li.textContent=s.val();
      historico.prepend(li);
    });
  });
}

function ouvirDT(){
  onValue(ref(db,"DT"), s=>DT=Number(s.val())||0);
}

function ouvirStatusJogador(){
  onValue(ref(db,`jogadores/${UID}_${nickAtual}`), s=>{
    if(!s.val()) return;
    infoJogador.innerText=`DT ${DT}`;
  });
}

/* ===== AÃ‡Ã•ES ===== */
btnRolar.addEventListener("click", ()=>{
  const r=ref(db,`jogadores/${UID}_${nickAtual}`);
  onValue(r,s=>{
    if(!s.val()||s.val().rolls<=0)return;
    const v=Math.floor(Math.random()*20)+1;
    push(ref(db,"historico"),`${nickAtual} rolou ${v}`);
    set(ref(db,`${r.key}/rolls`),0);
  },{onlyOnce:true});
});

btnDT.addEventListener("click", ()=>{
  set(ref(db,"DT"),Number(dtAtual.value));
});

btnLimpar.addEventListener("click", ()=>{
  remove(ref(db,"historico"));
});

function voltarParaEscolha() {
  telaLogin.innerHTML = "";
  telaLogin.appendChild(btnVoltar);
  telaLogin.appendChild(btnJogador);
  telaLogin.appendChild(btnMestre);

  btnVoltar.style.display = "none";
}

  
</script>

</body>
</html>


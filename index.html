<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesa de RPG</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:16px;
  margin:0;
}
button, input, select {
  padding:12px;
  margin:6px 0;
  width:100%;
  font-size:16px;
}
.box {
  border:1px solid #444;
  padding:12px;
  margin-top:12px;
  border-radius:8px;
}
#listaJogadores > div {
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
}
@media (min-width:768px) {
  body { max-width:700px; margin:auto }
}
</style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<!-- LOGIN -->
<div id="telaLogin">
  <button onclick="mostrarJogador()">Jogador</button>
  <button onclick="mostrarMestre()">Mestre</button>

  <div id="loginJogador" style="display:none">
    <input id="nickJogador" placeholder="Nickname">
    <button onclick="entrarJogador()">Entrar</button>
    <button onclick="voltar()">â¬… Voltar</button>
  </div>

  <div id="loginMestre" style="display:none">
    <input id="nickMestre" placeholder="Nick do Mestre">
    <input id="senhaMestre" placeholder="Senha">
    <button onclick="entrarMestre()">Entrar</button>
    <button onclick="voltar()">â¬… Voltar</button>
  </div>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">
  <h2 id="bemVindo"></h2>
  <button onclick="logout()">ðŸšª Sair</button>

  <!-- MESTRE -->
  <div id="controleMestre" class="box" style="display:none">
    <h3>Controle do Mestre</h3>

    <label>DT</label>
    <input id="dtAtual" type="number">
    <button onclick="definirDT()">Definir DT</button>
    <button onclick="limparHistorico()">ðŸ§¹ Limpar histÃ³rico</button>

    <h4>Jogadores ativos</h4>
    <div id="listaJogadores"></div>
  </div>

  <!-- JOGADOR -->
  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button onclick="rolarDado()">ðŸŽ² Rolar dado</button>
  </div>

  <h3>HistÃ³rico</h3>
  <ul id="historico"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let DT = 0;

/* ===== LOGIN ===== */

window.mostrarJogador = () => {
  loginJogador.style.display = "block";
  loginMestre.style.display = "none";
};

window.mostrarMestre = () => {
  loginMestre.style.display = "block";
  loginJogador.style.display = "none";
};

window.voltar = () => {
  loginJogador.style.display = "none";
  loginMestre.style.display = "none";
};

window.entrarJogador = () => {
  const nick = nickJogador.value.trim();
  if (!nick) return alert("Nick vazio");

  localStorage.clear();
  localStorage.setItem("tipo","jogador");
  localStorage.setItem("nick",nick);

  const r = ref(db,"jogadores/"+nick);
  set(r,{ rolls:0, dado:20, online:true });
  onDisconnect(r).remove();

  iniciar();
};

window.entrarMestre = () => {
  if (senhaMestre.value !== "souomestredosmagos")
    return alert("Senha errada");

  localStorage.clear();
  localStorage.setItem("tipo","mestre");
  localStorage.setItem("nick", nickMestre.value || "Mestre");

  iniciar();
};

window.logout = () => {
  localStorage.clear();
  location.reload();
};

/* ===== INICIAR ===== */

function iniciar() {
  telaLogin.style.display = "none";
  painel.style.display = "block";

  const tipo = localStorage.getItem("tipo");
  const nick = localStorage.getItem("nick");

  bemVindo.innerText = `${nick} (${tipo})`;

  ouvirDT();
  ouvirHistorico();

  if (tipo === "mestre") {
    controleMestre.style.display = "block";
    ouvirJogadores();
  } else {
    areaJogador.style.display = "block";
    ouvirStatusJogador();
  }
}

/* ===== FIREBASE ===== */

function ouvirJogadores() {
  onValue(ref(db,"jogadores"), snap => {
    listaJogadores.innerHTML="";
    snap.forEach(j=>{
      const d=j.val();
      if(!d?.online) return;

      const div=document.createElement("div");

      const btn=document.createElement("button");
      btn.innerText=j.key;
      btn.onclick=()=>darPermissao(j.key);

      const sel=document.createElement("select");
      [4,6,8,10,12,20].forEach(x=>{
        const o=document.createElement("option");
        o.value=x; o.innerText="d"+x;
        sel.appendChild(o);
      });
      sel.value=d.dado||20;
      sel.onchange=()=>set(ref(db,"jogadores/"+j.key+"/dado"),Number(sel.value));

      div.append(btn,sel);
      listaJogadores.appendChild(div);
    });
  });
}

function ouvirDT() {
  onValue(ref(db,"DT"),s=>{
    DT=Number(s.val())||0;
  });
}

function ouvirHistorico() {
  onValue(ref(db,"historico"),s=>{
    historico.innerHTML="";
    s.forEach(x=>{
      const li=document.createElement("li");
      li.innerText=x.val();
      historico.prepend(li);
    });
  });
}

function ouvirStatusJogador() {
  const nick=localStorage.getItem("nick");
  onValue(ref(db,"jogadores/"+nick),s=>{
    const j=s.val();
    if(!j) return;
    infoJogador.innerText=`Rolagens: ${j.rolls} | Dado: d${j.dado} | DT: ${DT}`;
  });
}

/* ===== AÃ‡Ã•ES ===== */

window.darPermissao = nick => {
  const r=Number(prompt("Quantas rolagens?"));
  if(isNaN(r)) return;
  set(ref(db,"jogadores/"+nick+"/rolls"),r);
};

window.definirDT = () => {
  const v=Number(dtAtual.value);
  if(isNaN(v)) return;
  set(ref(db,"DT"),v);
};

window.limparHistorico = () => {
  if(confirm("Limpar histÃ³rico?"))
    remove(ref(db,"historico"));
};

window.rolarDado = () => {
  const nick=localStorage.getItem("nick");
  onValue(ref(db,"jogadores/"+nick),s=>{
    const j=s.val();
    if(!j||j.rolls<=0) return alert("Sem permissÃ£o");

    const v=Math.floor(Math.random()*j.dado)+1;
    const res=v>=DT?"SUCESSO":"FALHA";

    push(ref(db,"historico"),
      `${nick} rolou d${j.dado} â†’ ${v} | DT ${DT} â†’ ${res}`
    );

    set(ref(db,"jogadores/"+nick+"/rolls"),j.rolls-1);
  },{onlyOnce:true});
};
</script>

</body>
</html>

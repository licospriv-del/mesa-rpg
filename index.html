<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesa de RPG</title>

<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial;
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
h1{
  text-align:center;
  margin:12px 0;
}
h2,h3,h4{margin:8px 0}
button,input,select{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px
}
.box{
  border:1px solid #444;
  padding:12px;
  margin-top:12px;
  border-radius:8px
}
#listaJogadores>div{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
  border-bottom:1px solid #333;
  padding-bottom:8px
}
.codigoSala{
  background:#222;
  padding:10px;
  border-radius:6px;
  font-family:monospace;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px
}

.central{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
}

.coluna{
  width:100%;
  max-width:360px;
}

@media(min-width:768px){
  button,input,select{width:100%}
}
</style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<div class="central">
<div id="telaSala" class="coluna">
  <button id="btnCriarSala">Criar sala</button>
  <button id="btnMostrarEntrar">Entrar na sala</button>
  <div id="areaEntrarSala" style="display:none">
    <input id="codigoSalaInput" placeholder="CÃ³digo da sala">
    <button id="btnEntrarSala">Confirmar</button>
  </div>
</div>

<div id="telaSenhaMestre" class="coluna" style="display:none">
  <input id="senhaMestreCriacao" type="password" placeholder="Senha do mestre">
  <button id="btnConfirmarSenhaMestre">Confirmar</button>
</div>

<div id="telaAuth" class="coluna" style="display:none">
  <input id="email" type="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button id="btnLogin">Entrar / Cadastrar</button>
</div>

<div id="telaLogin" class="coluna" style="display:none">
  <button id="btnJogador">Jogador</button>
  <button id="btnMestre">Mestre</button>
</div>

<div id="telaPersonagens" class="coluna" style="display:none">
  <button id="btnVoltar">â¬… Voltar</button>
  <div id="listaPersonagens"></div>
</div>
</div>

<div id="painel" style="display:none;padding:16px">
  <button id="btnSairMesa">ðŸšª Sair da mesa</button>

  <div id="codigoTopo" class="codigoSala" style="display:none">
    <span id="codigoTexto"></span>
    <button onclick="copiarCodigo()">ðŸ“‹ Copiar</button>
  </div>

  <h2 id="bemVindo"></h2>

  <div id="controleMestre" class="box" style="display:none">
    <h3>Controle do Mestre</h3>
    <input id="dtAtual" type="number" placeholder="DT">
    <button onclick="definirDT()">Definir DT</button>
    <button onclick="limparHistorico()">ðŸ§¹ Limpar histÃ³rico</button>
    <h4>Jogadores ativos</h4>
    <div id="listaJogadores"></div>
  </div>

  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button onclick="rolarDado()">ðŸŽ² Rolar dado</button>
  </div>

  <h3>HistÃ³rico</h3>
  <ul id="historico"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,signOut
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getDatabase,ref,set,onValue,
  remove,push,onDisconnect,get
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app=initializeApp({
  apiKey:"AIzaSyCzAXZ0RWY-RtgKVDUeqrnmImaN9hAxMmI",
  authDomain:"mesa-rpg-9f195.firebaseapp.com",
  databaseURL:"https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId:"mesa-rpg-9f195"
});
const auth=getAuth(app);
const db=getDatabase(app);

let UID=null,nickAtual=null,tipoAtual=null,salaAtual=null,DT=0;
let salaEscolhida=false;

const telas=[telaSala,telaSenhaMestre,telaAuth,telaLogin,telaPersonagens,painel];
const esconderTudo=()=>telas.forEach(t=>t.style.display="none");

await signOut(auth);
esconderTudo();
telaSala.style.display="block";

function gerarCodigo(){
  const c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&*";
  return Array.from({length:8},()=>c[Math.floor(Math.random()*c.length)]).join("");
}

btnCriarSala.onclick=()=>{
  esconderTudo();
  telaSenhaMestre.style.display="block";
};

btnConfirmarSenhaMestre.onclick=async()=>{
  if(!senhaMestreCriacao.value)return;
  let codigo;
  do{codigo=gerarCodigo();}
  while((await get(ref(db,"salas/"+codigo))).exists());

  salaAtual=codigo;
  salaEscolhida=true;
  await set(ref(db,"salas/"+codigo),{senhaMestre:senhaMestreCriacao.value,membros:1});
  esconderTudo();
  telaAuth.style.display="block";
};

btnMostrarEntrar.onclick=()=>{
  areaEntrarSala.style.display=areaEntrarSala.style.display==="none"?"block":"none";
};

btnEntrarSala.onclick=async()=>{
  const snap=await get(ref(db,"salas/"+codigoSalaInput.value));
  if(!snap.exists())return alert("Sala inexistente");
  salaAtual=codigoSalaInput.value;
  salaEscolhida=true;
  await set(ref(db,`salas/${salaAtual}/membros`),snap.val().membros+1);
  esconderTudo();
  telaAuth.style.display="block";
};

btnLogin.onclick=async()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,senha.value);
  }catch(e){
    if(e.code==="auth/user-not-found"){
      await createUserWithEmailAndPassword(auth,email.value,senha.value);
    }else if(e.code==="auth/wrong-password"){
      alert("Senha incorreta para este email.");
      return;
    }else{
      alert("Erro ao autenticar");
      return;
    }
  }
};

onAuthStateChanged(auth,u=>{
  if(!u||!salaEscolhida)return;
  UID=u.uid;
  esconderTudo();
  telaLogin.style.display="block";
});

btnMestre.onclick=async()=>{
  const s=await get(ref(db,`salas/${salaAtual}/senhaMestre`));
  if(prompt("Senha do mestre")!==s.val())return alert("Senha incorreta");
  tipoAtual="mestre";
  iniciar();
};

btnJogador.onclick=()=>{
  esconderTudo();
  telaPersonagens.style.display="block";
  listaPersonagens.innerHTML="";
  onValue(ref(db,`usuarios/${UID}/personagens`),snap=>{
    snap.forEach(p=>{
      const b=document.createElement("button");
      b.textContent=p.key;
      b.onclick=()=>entrarPersonagem(p.key,false);
      listaPersonagens.appendChild(b);
    });
    const n=document.createElement("button");
    n.textContent="âž• Novo personagem";
    n.onclick=()=>entrarPersonagem(prompt("Nome"),true);
    listaPersonagens.appendChild(n);
  },{onlyOnce:true});
};

btnVoltar.onclick=()=>{
  esconderTudo();
  telaLogin.style.display="block";
};

function entrarPersonagem(nick,novo){
  nickAtual=nick;
  tipoAtual="jogador";
  const id=`${UID}_${nick}`;
  const r=ref(db,`salas/${salaAtual}/jogadores/${id}`);
  set(r,{nick,rolls:0,dado:20,online:true});
  if(novo)set(ref(db,`usuarios/${UID}/personagens/${nick}`),true);
  onDisconnect(r).remove();
  iniciar();
}

function iniciar(){
  esconderTudo();
  painel.style.display="block";
  bemVindo.textContent=tipoAtual==="mestre"?"Mestre":nickAtual;
  ouvirDT();
  ouvirHistorico();
  if(tipoAtual==="mestre"){
    codigoTopo.style.display="flex";
    codigoTexto.textContent="CÃ³digo: "+salaAtual;
    controleMestre.style.display="block";
    ouvirJogadores();
  }else{
    areaJogador.style.display="block";
    ouvirStatusJogador();
  }
}

function ouvirJogadores(){
  onValue(ref(db,`salas/${salaAtual}/jogadores`),snap=>{
    listaJogadores.innerHTML="";
    snap.forEach(j=>{
      const d=j.val();
      if(!d?.online)return;
      const div=document.createElement("div");
      const btn=document.createElement("button");
      btn.textContent=d.nick;
      btn.onclick=()=>darPermissao(j.key);
      const sel=document.createElement("select");
      [4,6,8,10,12,20].forEach(x=>{
        const o=document.createElement("option");
        o.value=x;o.textContent="d"+x;
        sel.appendChild(o);
      });
      sel.value=d.dado||20;
      sel.onchange=()=>set(ref(db,`salas/${salaAtual}/jogadores/${j.key}/dado`),Number(sel.value));
      div.append(btn,sel);
      listaJogadores.appendChild(div);
    });
  });
}

function ouvirDT(){
  onValue(ref(db,`salas/${salaAtual}/DT`),s=>DT=Number(s.val())||0);
}

function ouvirHistorico(){
  onValue(ref(db,`salas/${salaAtual}/historico`),snap=>{
    historico.innerHTML="";
    snap.forEach(x=>{
      const li=document.createElement("li");
      li.textContent=x.val();
      historico.prepend(li);
    });
  });
}

function ouvirStatusJogador(){
  const id=`${UID}_${nickAtual}`;
  onValue(ref(db,`salas/${salaAtual}/jogadores/${id}`),snap=>{
    const j=snap.val();
    if(j)infoJogador.textContent=`Rolagens: ${j.rolls} | Dado: d${j.dado} | DT: ${DT}`;
  });
}

window.copiarCodigo=()=>{
  navigator.clipboard.writeText(salaAtual);
};

window.darPermissao=id=>{
  const r=Number(prompt("Quantas rolagens?"));
  if(!isNaN(r))set(ref(db,`salas/${salaAtual}/jogadores/${id}/rolls`),r);
};

window.definirDT=()=>{
  const v=Number(dtAtual.value);
  if(!isNaN(v))set(ref(db,`salas/${salaAtual}/DT`),v);
};

window.limparHistorico=()=>{
  if(confirm("Limpar histÃ³rico?"))
    remove(ref(db,`salas/${salaAtual}/historico`));
};

window.rolarDado=()=>{
  const id=`${UID}_${nickAtual}`;
  onValue(ref(db,`salas/${salaAtual}/jogadores/${id}`),snap=>{
    const j=snap.val();
    if(!j||j.rolls<=0)return alert("Sem permissÃ£o");
    const v=Math.floor(Math.random()*j.dado)+1;
    const res=v>=DT?"SUCESSO":"FALHA";
    push(ref(db,`salas/${salaAtual}/historico`),
      `${j.nick} rolou d${j.dado} â†’ ${v} | DT ${DT} â†’ ${res}`
    );
    set(ref(db,`salas/${salaAtual}/jogadores/${id}/rolls`),j.rolls-1);
  },{onlyOnce:true});
};

btnSairMesa.onclick=async()=>{
  if(nickAtual)remove(ref(db,`salas/${salaAtual}/jogadores/${UID}_${nickAtual}`));
  const mRef=ref(db,`salas/${salaAtual}/membros`);
  const s=await get(mRef);
  if(s.val()-1<=0)remove(ref(db,`salas/${salaAtual}`));
  else set(mRef,s.val()-1);
  await signOut(auth);
  location.reload();
};
</script>

</body>
</html>

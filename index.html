<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesa de RPG</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:16px;
  margin:0;
}
h1,h2,h3,h4{margin:8px 0}
button,input,select{
  padding:12px;
  margin:6px 0;
  width:100%;
  font-size:16px;
}
.box{
  border:1px solid #444;
  padding:12px;
  margin-top:12px;
  border-radius:8px;
}
@media (min-width:768px){
  body{max-width:700px;margin:auto}
  button,input,select{width:auto}
}
</style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<!-- ðŸ” SENHA GLOBAL -->
<div id="telaSenha">
  <input id="senhaGlobal" type="password" placeholder="Senha da mesa">
  <button onclick="verificarSenha()">Entrar</button>
</div>

<!-- ðŸ”‘ LOGIN UID -->
<div id="telaAuth" style="display:none">
  <input id="email" type="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar / Cadastrar</button>
</div>

<!-- ESCOLHA -->
<div id="telaLogin" style="display:none">
  <button onclick="mostrarJogador()">Jogador</button>
  <button onclick="mostrarMestre()">Mestre</button>
</div>

<!-- JOGADOR -->
<div id="loginJogador" class="box" style="display:none">
  <h3>Personagens</h3>
  <div id="listaPersonagens"></div>

  <input id="novoNick" placeholder="Novo personagem">
  <button onclick="criarPersonagem()">Criar personagem</button>
</div>

<!-- MESTRE -->
<div id="loginMestre" class="box" style="display:none">
  <input id="nickMestre" placeholder="Nick do Mestre">
  <input id="senhaMestre" type="password" placeholder="Senha do Mestre">
  <button onclick="entrarMestre()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">
  <h2 id="bemVindo"></h2>

  <div id="controleMestre" class="box" style="display:none">
    <input id="dtAtual" type="number" placeholder="DT">
    <button onclick="definirDT()">Definir DT</button>
    <button onclick="limparHistorico()">ðŸ§¹ Limpar histÃ³rico</button>
    <div id="listaJogadores"></div>
  </div>

  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button onclick="rolarDado()">ðŸŽ² Rolar dado</button>
  </div>

  <ul id="historico"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let UID = null;
let personagemAtual = null;
let DT = 0;

/* ðŸ” senha global */
window.verificarSenha = () => {
  if (senhaGlobal.value !== "somosumbra") return alert("Senha incorreta");
  telaSenha.style.display = "none";
  telaAuth.style.display = "block";
};

/* ðŸ”‘ login / cadastro */
window.login = () => {
  signInWithEmailAndPassword(auth, email.value, senha.value)
    .catch(() => createUserWithEmailAndPassword(auth, email.value, senha.value));
};

onAuthStateChanged(auth, user => {
  if (!user) return;
  UID = user.uid;
  telaAuth.style.display = "none";
  telaLogin.style.display = "block";
});

/* escolha */
window.mostrarJogador = () => {
  telaLogin.style.display = "none";
  loginJogador.style.display = "block";
  carregarPersonagens();
};

window.mostrarMestre = () => {
  telaLogin.style.display = "none";
  loginMestre.style.display = "block";
};

/* personagens */
function carregarPersonagens() {
  onValue(ref(db, `users/${UID}/personagens`), snap => {
    listaPersonagens.innerHTML = "";
    snap.forEach(p => {
      const b = document.createElement("button");
      b.innerText = p.val().nome;
      b.onclick = () => entrarJogador(p.key, p.val().nome);
      listaPersonagens.appendChild(b);
    });
  });
}

window.criarPersonagem = () => {
  if (!novoNick.value.trim()) return;
  push(ref(db, `users/${UID}/personagens`), {
    nome: novoNick.value,
    dado: 20,
    rolls: 0
  });
  novoNick.value = "";
};

window.entrarJogador = (id, nome) => {
  personagemAtual = id;
  localStorage.setItem("tipo", "jogador");
  localStorage.setItem("nick", nome);
  iniciar();
};

/* mestre */
window.entrarMestre = () => {
  if (senhaMestre.value !== "souomestredosmagos") return alert("Senha errada");
  localStorage.setItem("tipo", "mestre");
  localStorage.setItem("nick", nickMestre.value || "Mestre");
  iniciar();
};

/* iniciar */
function iniciar() {
  loginJogador.style.display = "none";
  loginMestre.style.display = "none";
  painel.style.display = "block";
  bemVindo.innerText = localStorage.getItem("nick");

  ouvirDT();
  ouvirHistorico();

  if (localStorage.getItem("tipo") === "mestre") {
    controleMestre.style.display = "block";
    ouvirJogadores();
  } else {
    areaJogador.style.display = "block";
    ouvirStatusJogador();
  }
}

/* firebase mesa */
function ouvirJogadores() {
  onValue(ref(db, "users"), snap => {
    listaJogadores.innerHTML = "";
    snap.forEach(u => {
      const pers = u.child("personagens");
      pers.forEach(p => {
        const b = document.createElement("button");
        b.innerText = p.val().nome;
        b.onclick = () => darPermissao(u.key, p.key);
        listaJogadores.appendChild(b);
      });
    });
  });
}

function ouvirHistorico() {
  onValue(ref(db, "historico"), snap => {
    historico.innerHTML = "";
    snap.forEach(s => {
      const li = document.createElement("li");
      li.innerText = s.val();
      historico.prepend(li);
    });
  });
}

function ouvirDT() {
  onValue(ref(db, "DT"), s => DT = Number(s.val()) || 0);
}

function ouvirStatusJogador() {
  onValue(ref(db, `users/${UID}/personagens/${personagemAtual}`), snap => {
    const j = snap.val();
    infoJogador.innerText =
      `Rolagens: ${j.rolls} | Dado: d${j.dado} | DT: ${DT}`;
  });
}

/* aÃ§Ãµes */
window.darPermissao = (uid, pid) => {
  const r = Number(prompt("Rolagens"));
  if (!isNaN(r))
    set(ref(db, `users/${uid}/personagens/${pid}/rolls`), r);
};

window.definirDT = () => set(ref(db, "DT"), Number(dtAtual.value));

window.limparHistorico = () => remove(ref(db, "historico"));

window.rolarDado = () => {
  const refPers = ref(db, `users/${UID}/personagens/${personagemAtual}`);
  onValue(refPers, snap => {
    const j = snap.val();
    if (j.rolls <= 0) return alert("Sem permissÃ£o");
    const v = Math.floor(Math.random() * j.dado) + 1;
    push(ref(db, "historico"),
      `${j.nome} rolou d${j.dado} â†’ ${v}`);
    set(ref(db, `${refPers.path}/rolls`), j.rolls - 1);
  }, { onlyOnce: true });
};
</script>

</body>
</html>

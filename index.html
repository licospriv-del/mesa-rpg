<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesa de RPG</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:16px;
  margin:0;
}
h1,h2,h3,h4{margin:8px 0}
button,input,select{
  padding:12px;
  margin:6px 0;
  width:100%;
  font-size:16px;
}
.box{
  border:1px solid #444;
  padding:12px;
  margin-top:12px;
  border-radius:8px;
}
@media (min-width:768px){
  body{max-width:700px;margin:auto}
  button,input,select{width:auto}
}
</style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<!-- ðŸ” SENHA GLOBAL -->
<div id="telaSenha">
  <input id="senhaGlobal" type="password" placeholder="Senha da mesa">
  <button id="btnSenha">Entrar</button>
</div>

<!-- ðŸ”‘ LOGIN UID -->
<div id="telaAuth" style="display:none">
  <input id="email" type="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
 <button id="btnLogin">Entrar / Cadastrar</button>
</div>

<!-- ESCOLHA -->
<div id="telaLogin" style="display:none">
  <button onclick="mostrarJogador()">Jogador</button>
  <button onclick="mostrarMestre()">Mestre</button>
</div>

<!-- JOGADOR -->
<div id="loginJogador" class="box" style="display:none">
  <h3>Personagens</h3>
  <div id="listaPersonagens"></div>

  <input id="novoNick" placeholder="Novo personagem">
  <button onclick="criarPersonagem()">Criar personagem</button>
</div>

<!-- MESTRE -->
<div id="loginMestre" class="box" style="display:none">
  <input id="nickMestre" placeholder="Nick do Mestre">
  <input id="senhaMestre" type="password" placeholder="Senha do Mestre">
  <button onclick="entrarMestre()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">
  <h2 id="bemVindo"></h2>

  <div id="controleMestre" class="box" style="display:none">
    <input id="dtAtual" type="number" placeholder="DT">
    <button onclick="definirDT()">Definir DT</button>
    <button onclick="limparHistorico()">ðŸ§¹ Limpar histÃ³rico</button>
    <div id="listaJogadores"></div>
  </div>

  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button onclick="rolarDado()">ðŸŽ² Rolar dado</button>
  </div>

  <ul id="historico"></ul>
</div>

<script type="module">

  // ===== BIND DE BOTÃ•ES (IMPORTANTE PARA MODULE) =====
document.getElementById("btnSenha").addEventListener("click", () => {
  const senha = senhaGlobal.value.trim();

  if (senha !== "somosumbra") {
    alert("Senha incorreta");
    return;
  }

  telaSenha.style.display = "none";
  telaAuth.style.display = "block";
});

document.getElementById("btnLogin").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();

  if (!email || !senha) {
    alert("Preencha email e senha");
    return;
  }

  try {
    await signInWithEmailAndPassword(auth, email, senha);
  } catch {
    await createUserWithEmailAndPassword(auth, email, senha);
  }
});

  
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

import {
  getDatabase,
  ref,
  set,
  onValue,
  push,
  remove,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let UID = null;
let nickAtual = null;
let DT = 0;

/* =========================
   LOGIN INICIAL (SOMOSUMBRA)
========================= */



/* =========================
   AUTH EMAIL/SENHA
========================= */


/* =========================
   ESCOLHA JOGADOR / MESTRE
========================= */
function escolherModo() {
  telaLogin.innerHTML = `
    <button onclick="modoJogador()">Jogador</button>
    <button onclick="modoMestre()">Mestre</button>
  `;
}

window.modoJogador = () => {
  const base = ref(db, `usuarios/${UID}/personagens`);
  onValue(base, snap => {
    let html = "<h3>Escolha um personagem</h3>";
    snap.forEach(p => {
      html += `<button onclick="entrarPersonagem('${p.key}')">${p.key}</button>`;
    });
    html += `<button onclick="novoPersonagem()">âž• Novo personagem</button>`;
    telaLogin.innerHTML = html;
  }, { onlyOnce:true });
};

window.novoPersonagem = () => {
  const nick = prompt("Nome do personagem");
  if (!nick) return;
  entrarPersonagem(nick, true);
};

window.entrarPersonagem = (nick, novo=false) => {
  nickAtual = nick;

  const refJogador = ref(db, `jogadores/${UID}_${nick}`);
  set(refJogador, {
    uid: UID,
    nick,
    rolls: 0,
    dado: 20,
    online: true
  });

  if (novo) {
    set(ref(db, `usuarios/${UID}/personagens/${nick}`), {
      criado: Date.now()
    });
  }

  onDisconnect(refJogador).remove();
  iniciar("jogador");
};

window.modoMestre = () => {
  const senha = prompt("Senha do mestre");
  if (senha !== "souomestredosmagos") {
    alert("Senha errada");
    return;
  }
  iniciar("mestre");
};

/* =========================
   INICIAR SISTEMA
========================= */
function iniciar(tipo) {
  telaLogin.style.display = "none";
  painel.style.display = "block";
  bemVindo.innerText = `${nickAtual || "Mestre"} (${tipo})`;

  ouvirDT();
  ouvirHistorico();

  if (tipo === "mestre") {
    controleMestre.style.display = "block";
    ouvirJogadores();
  } else {
    areaJogador.style.display = "block";
    ouvirStatusJogador();
  }
}

/* =========================
   FIREBASE
========================= */
function ouvirJogadores() {
  onValue(ref(db, "jogadores"), snap => {
    listaJogadores.innerHTML = "";
    snap.forEach(j => {
      const d = j.val();
      if (!d?.online) return;

      const div = document.createElement("div");
      div.innerText = d.nick;
      listaJogadores.appendChild(div);
    });
  });
}

function ouvirHistorico() {
  onValue(ref(db, "historico"), snap => {
    historico.innerHTML = "";
    snap.forEach(s => {
      const li = document.createElement("li");
      li.innerText = s.val();
      historico.prepend(li);
    });
  });
}

function ouvirDT() {
  onValue(ref(db, "DT"), snap => DT = Number(snap.val()) || 0);
}

function ouvirStatusJogador() {
  onValue(ref(db, `jogadores/${UID}_${nickAtual}`), snap => {
    const j = snap.val();
    if (!j) return;
    infoJogador.innerText =
      `Rolagens: ${j.rolls} | Dado: d${j.dado} | DT: ${DT}`;
  });
}

/* =========================
   ROLAGEM
========================= */
window.rolarDado = () => {
  const refJ = ref(db, `jogadores/${UID}_${nickAtual}`);
  onValue(refJ, snap => {
    const j = snap.val();
    if (!j || j.rolls <= 0) return alert("Sem permissÃ£o");

    const v = Math.floor(Math.random() * j.dado) + 1;
    const r = v >= DT ? "SUCESSO" : "FALHA";

    push(ref(db, "historico"),
      `${j.nick} rolou d${j.dado} â†’ ${v} | DT ${DT} â†’ ${r}`
    );

    set(ref(db, `${refJ.key}/rolls`), j.rolls - 1);
  }, { onlyOnce:true });
};
</script>

</body>
</html>





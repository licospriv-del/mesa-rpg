<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Mesa de RPG</title>
  <style>
    body { background:#111; color:#fff; font-family:Arial; padding:20px }
    button { padding:6px 12px; margin:4px }
    input, select { padding:6px }
    .box { border:1px solid #444; padding:10px; margin-top:10px }
  </style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<!-- TELA LOGIN -->
<div id="telaLogin">
  <button onclick="mostrarJogador()">Jogador</button>
  <button onclick="mostrarMestre()">Mestre</button>

  <div id="loginJogador" style="display:none">
    <input id="nickJogador" placeholder="Nickname">
    <button onclick="entrarJogador()">Entrar</button>
  </div>

  <div id="loginMestre" style="display:none">
    <input id="nickMestre" placeholder="Nick do Mestre">
    <input id="senhaMestre" placeholder="Senha">
    <button onclick="entrarMestre()">Entrar</button>
  </div>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">
  <h2 id="bemVindo"></h2>

  <div id="controleMestre" class="box" style="display:none">
    <h3>Controle do Mestre</h3>
    DT: <input id="dtAtual" type="number">
    <button onclick="definirDT()">Definir</button>

    <h4>Jogadores</h4>
    <div id="listaJogadores"></div>
  </div>

  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button onclick="rolarDado()">Rolar dado</button>
  </div>

  <h3>HistÃ³rico</h3>
  <ul id="historico"></ul>
</div>

<!-- ðŸ”¥ JAVASCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzAXZ0RWY-RtgKVDUeqrnmImaN9hAxMmI",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== LOGIN =====
window.mostrarJogador = () => {
  loginJogador.style.display = "block";
  loginMestre.style.display = "none";
};

window.mostrarMestre = () => {
  loginMestre.style.display = "block";
  loginJogador.style.display = "none";
};

window.entrarJogador = () => {
  const nick = nickJogador.value.trim();
  if (!nick) return alert("Nick vazio");
  localStorage.setItem("tipo","jogador");
  localStorage.setItem("nick",nick);
  set(ref(db,"jogadores/"+nick),{ dado:20, rolls:0 });
  iniciar();
};

window.entrarMestre = () => {
  if (senhaMestre.value !== "souomestredosmagos") return alert("Senha errada");
  localStorage.setItem("tipo","mestre");
  localStorage.setItem("nick",nickMestre.value);
  iniciar();
};

function iniciar(){
  telaLogin.style.display="none";
  painel.style.display="block";
  bemVindo.innerText = localStorage.getItem("nick")+" ("+localStorage.getItem("tipo")+")";

  if(localStorage.getItem("tipo")==="mestre"){
    controleMestre.style.display="block";
  } else {
    areaJogador.style.display="block";
  }
}

// ===== FIREBASE =====
onValue(ref(db,"jogadores"), snap=>{
  listaJogadores.innerHTML="";
  snap.forEach(s=>{
    const btn=document.createElement("button");
    btn.innerText=s.key;
    btn.onclick=()=>darPermissao(s.key);
    listaJogadores.appendChild(btn);
  });
});

onValue(ref(db,"historico"), snap=>{
  historico.innerHTML="";
  snap.forEach(s=>{
    const li=document.createElement("li");
    li.innerText=s.val();
    historico.prepend(li);
  });
});

// ===== MESTRE =====
window.darPermissao = nick =>{
  const rolls = prompt("Quantas rolagens?");
  set(ref(db,"jogadores/"+nick+"/rolls"), Number(rolls));
};

window.definirDT = ()=>{
  set(ref(db,"DT"), Number(dtAtual.value));
};

// ===== JOGADOR =====
window.rolarDado = ()=>{
  const nick=localStorage.getItem("nick");
  onValue(ref(db,"jogadores/"+nick), snap=>{
    const j=snap.val();
    if(!j || j.rolls<=0) return alert("Sem permissÃ£o");
    const v=Math.floor(Math.random()*21);
    push(ref(db,"historico"), `${nick} rolou ${v}`);
    set(ref(db,"jogadores/"+nick+"/rolls"), j.rolls-1);
  },{onlyOnce:true});
};
</script>

</body>
</html>

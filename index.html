<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Mesa de RPG</title>

  <style>
    body { background:#111; color:#fff; font-family:Arial; padding:20px }
    button { padding:6px 12px; margin:4px }
    input, select { padding:6px; margin:4px }
    .box { border:1px solid #444; padding:10px; margin-top:10px }
  </style>
</head>

<body>

<h1>Mesa de RPG ðŸŽ²</h1>

<!-- LOGIN -->
<div id="telaLogin">
  <button onclick="mostrarJogador()">Jogador</button>
  <button onclick="mostrarMestre()">Mestre</button>

  <div id="loginJogador" style="display:none">
    <input id="nickJogador" placeholder="Nickname">
    <button onclick="entrarJogador()">Entrar</button>
  </div>

  <div id="loginMestre" style="display:none">
    <input id="nickMestre" placeholder="Nick do Mestre">
    <input id="senhaMestre" placeholder="Senha">
    <button onclick="entrarMestre()">Entrar</button>
  </div>
</div>

<!-- PAINEL -->
<div id="painel" style="display:none">
  <h2 id="bemVindo"></h2>

  <!-- MESTRE -->
  <div id="controleMestre" class="box" style="display:none">
    <h3>Controle do Mestre</h3>

    DT:
    <input id="dtAtual" type="number">
    <button onclick="definirDT()">Definir</button>

    <button onclick="limparHistorico()">ðŸ§¹ Limpar histÃ³rico</button>

    <h4>Jogadores ativos</h4>
    <div id="listaJogadores"></div>
  </div>

  <!-- JOGADOR -->
  <div id="areaJogador" class="box" style="display:none">
    <p id="infoJogador"></p>
    <button onclick="rolarDado()">Rolar dado</button>
  </div>

  <h3>HistÃ³rico</h3>
  <ul id="historico"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY_AQUI",
  authDomain: "mesa-rpg-9f195.firebaseapp.com",
  databaseURL: "https://mesa-rpg-9f195-default-rtdb.firebaseio.com",
  projectId: "mesa-rpg-9f195",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let DT = 0;

// ===== LOGIN =====
window.mostrarJogador = () => {
  loginJogador.style.display = "block";
  loginMestre.style.display = "none";
};

window.mostrarMestre = () => {
  loginMestre.style.display = "block";
  loginJogador.style.display = "none";
};

window.entrarJogador = () => {
  const nick = nickJogador.value.trim();
  if (!nick) return alert("Nick vazio");

  localStorage.setItem("tipo", "jogador");
  localStorage.setItem("nick", nick);

  const refJogador = ref(db, "jogadores/" + nick);

  set(refJogador, {
    rolls: 0,
    dado: 20,
    online: true
  });

  onDisconnect(refJogador).remove();

  iniciar();
};

window.entrarMestre = () => {
  if (senhaMestre.value !== "souomestredosmagos") {
    return alert("Senha errada");
  }

  localStorage.setItem("tipo", "mestre");
  localStorage.setItem("nick", nickMestre.value || "Mestre");

  iniciar();
};

// ===== INICIAR =====
function iniciar() {
  telaLogin.style.display = "none";
  painel.style.display = "block";

  bemVindo.innerText =
    localStorage.getItem("nick") +
    " (" +
    localStorage.getItem("tipo") +
    ")";

  ouvirDT();
  ouvirHistorico();

  if (localStorage.getItem("tipo") === "mestre") {
    controleMestre.style.display = "block";
    ouvirJogadores();
  } else {
    areaJogador.style.display = "block";
    ouvirStatusJogador();
  }
}

// ===== FIREBASE =====
function ouvirJogadores() {
  onValue(ref(db, "jogadores"), snap => {
    listaJogadores.innerHTML = "";
    snap.forEach(j => {
      const dados = j.val();
      if (!dados?.online) return;

      const div = document.createElement("div");

      const btn = document.createElement("button");
      btn.innerText = j.key;
      btn.onclick = () => darPermissao(j.key);

      const select = document.createElement("select");
      [4,6,8,10,12,20].forEach(d => {
        const o = document.createElement("option");
        o.value = d;
        o.innerText = "d" + d;
        select.appendChild(o);
      });

      select.value = dados.dado || 20;
      select.onchange = () => {
        set(ref(db, "jogadores/" + j.key + "/dado"), Number(select.value));
      };

      div.appendChild(btn);
      div.appendChild(select);
      listaJogadores.appendChild(div);
    });
  });
}

function ouvirHistorico() {
  onValue(ref(db, "historico"), snap => {
    historico.innerHTML = "";
    snap.forEach(s => {
      const li = document.createElement("li");
      li.innerText = s.val();
      historico.prepend(li);
    });
  });
}

function ouvirDT() {
  onValue(ref(db, "DT"), snap => {
    if (snap.exists()) DT = snap.val();
  });
}

function ouvirStatusJogador() {
  const nick = localStorage.getItem("nick");
  onValue(ref(db, "jogadores/" + nick), snap => {
    const j = snap.val();
    if (!j) return;
    infoJogador.innerText =
      `Rolagens restantes: ${j.rolls} | Dado: d${j.dado} | DT atual: ${DT}`;
  });
}

// ===== MESTRE =====
window.darPermissao = nick => {
  const rolls = Number(prompt("Quantas rolagens?"));
  if (isNaN(rolls)) return;

  set(ref(db, "jogadores/" + nick + "/rolls"), rolls);
};

window.definirDT = () => {
  const v = Number(dtAtual.value);
  if (isNaN(v)) return alert("DT invÃ¡lida");
  set(ref(db, "DT"), v);
};

window.limparHistorico = () => {
  if (!confirm("Limpar histÃ³rico para todos?")) return;
  remove(ref(db, "historico"));
};

// ===== JOGADOR =====
window.rolarDado = () => {
  const nick = localStorage.getItem("nick");

  onValue(ref(db, "jogadores/" + nick), snap => {
    const j = snap.val();
    if (!j || j.rolls <= 0) {
      alert("Sem permissÃ£o");
      return;
    }

    const valor = Math.floor(Math.random() * j.dado) + 1;
    const resultado = valor >= DT ? "SUCESSO" : "FALHA";

    push(
      ref(db, "historico"),
      `${nick} rolou d${j.dado} â†’ ${valor} | DT ${DT} â†’ ${resultado}`
    );

    set(ref(db, "jogadores/" + nick + "/rolls"), j.rolls - 1);
  }, { onlyOnce: true });
};
</script>

</body>
</html>
